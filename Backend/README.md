# Spotify Lyrics & Song Downloader API

Это серверное приложение на Node.js, созданное с использованием Express и интегрированное с различными API для работы со Spotify, Genius и YouTube. Приложение позволяет:

- Получать текущую воспроизводимую песню из аккаунта Spotify.
- Загружать текст песни через Spotify API.
- Выполнять поиск и загрузку песни с YouTube, преобразовывая видео в MP3.
- Обеспечивать авторизацию через Spotify и автоматическое обновление access token.

## Функциональные возможности

- **Интеграция с Spotify API**  
  Используется официальный [spotify-web-api-node](https://github.com/thelinmichael/spotify-web-api-node) для работы с авторизацией, получения текущего воспроизведения и управления токенами.

- **Получение текста песни**  
  Класс `Spotify` реализует логику получения токена доступа для запроса текстов песни через endpoint Spotify. При необходимости производится обновление токена и кэширование.

- **Поиск текстов через Genius**  
  Реализован поиск текстов песни через Genius API с использованием `axios` и парсинга HTML с помощью `cheerio`.

- **Загрузка песни с YouTube**  
  Реализована функция поиска видео на YouTube по названию песни и имени исполнителя, после чего происходит скачивание аудио (MP3) с использованием утилиты `yt-dlp` и временного хранения файла в системной временной папке.

- **Обновление access token**  
  Приложение автоматически обновляет access token Spotify через заданные интервалы времени (55 минут) для поддержания постоянной авторизации.

## Требования

- Node.js (рекомендуется последняя LTS-версия)
- NPM (или другой менеджер пакетов)
- Установленная утилита `yt-dlp` для загрузки аудио с YouTube (должна быть доступна из командной строки)
- Доступ к Spotify, Genius и YouTube API

## Установка и запуск

1. **Клонирование репозитория**  
   Склонируйте репозиторий или загрузите файлы проекта на вашу локальную машину.

2. **Установка зависимостей**  
   Выполните команду:
   ```bash
   npm install
   ```

3. **Настройка переменных окружения**
Создайте файл .env в корневой директории проекта и добавьте следующие переменные:
```bash
SPOTIFY_CLIENT_ID=ваш_spotify_client_id
SPOTIFY_CLIENT_SECRET=ваш_spotify_client_secret
SPOTIFY_REDIRECT_URI=ваш_spotify_redirect_uri
SP_DC=ваш_sp_dc_cookie_value
GENIUS_API_TOKEN=ваш_genius_api_token
YOUTUBE_API_KEY=ваш_youtube_api_key
```

4. **Запуск сервера**
Для запуска сервера выполните команду:
node index.js

Сервер будет запущен на порту 3012, и вы увидите сообщение в консоли:
Server running on http://localhost:3012

API эндпоинты
	•	GET /download-current-song
Загружает текущую песню с YouTube и отправляет MP3-файл клиенту. Заголовки ответа содержат название песни и исполнителя.
	•	GET /currently-playing
Возвращает JSON с информацией о текущей воспроизводимой песне: название, исполнитель, альбом, изображение обложки, прогресс воспроизведения, ссылки на Spotify и Genius, а также текст песни и временные задержки запросов.
	•	GET /mazafakatospotik
Редирект на страницу авторизации Spotify с необходимыми правами доступа.
	•	GET /callback
Обработка callback-запроса после авторизации Spotify, получение и сохранение access/refresh токенов.

Логика работы
	1.	Кэширование и обновление токенов
	•	Токены сохраняются в файле spotify-tokens.json.
	•	При запуске приложения производится попытка загрузить ранее сохранённые токены.
	•	Если access token истек или отсутствует, выполняется запрос на его обновление.
	2.	Получение текста песни через Spotify
	•	Класс Spotify реализует методы для запроса токена и получения текста песни с использованием специализированного endpoint.
	3.	Скачивание песни с YouTube
	•	Функция downloadSongFromYouTube выполняет поиск видео на YouTube по запросу (название песни и исполнитель) с использованием YouTube Data API.
	•	Затем с помощью yt-dlp происходит скачивание аудио в формате MP3, которое временно сохраняется и отправляется клиенту.
	4.	Постоянное обновление токена
	•	С помощью setInterval access token автоматически обновляется каждые 55 минут для обеспечения стабильной работы приложения.
